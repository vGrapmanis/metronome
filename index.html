<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metronome</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f39c12;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .bpm-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bpm-display input {
      font-size: 24px;
      width: 60px;
      text-align: center;
      padding: 5px;
    }
    button {
      font-size: 24px;
      padding: 8px 12px;
      border: 2px solid #555;
      border-radius: 8px;
      background: white;
      cursor: pointer;
    }
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .start-stop {
      padding: 10px 20px;
      background: #2980b9;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
    }
    input[type='range'] {
      width: 150px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="bpm-controls">
      <button id="bpm-down">⬇️</button>
      <div class="bpm-display">
        <input type="number" id="bpm-input" min="30" max="300" /> bpm
      </div>
      <button id="bpm-up">⬆️</button>
    </div>

    <div class="slider-container">
      <span>Volume</span>
      <input type="range" id="volume-slider" min="0" max="1" step="0.01" />
    </div>

    <button id="start-stop" class="start-stop">Start</button>
  </div>

  <script>
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    let currentTick = null;
    let intervalId = null;

    const bpmInput = document.getElementById('bpm-input');
    const bpmDown = document.getElementById('bpm-down');
    const bpmUp = document.getElementById('bpm-up');
    const volumeSlider = document.getElementById('volume-slider');
    const startStopBtn = document.getElementById('start-stop');

    // Load last BPM from localStorage
    let bpm = parseInt(localStorage.getItem('bpm')) || 80;
    let isRunning = false;
    let volume = parseFloat(localStorage.getItem('volume')) || 0.5;
    bpmInput.value = bpm;
    volumeSlider.value = volume;

    function tick() {
        const bufferSize = audioCtx.sampleRate * 0.1;
        const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);

        for (let i = 0; i < bufferSize; i++) {
            data[i] = Math.sin((2 * Math.PI * 880 * i) / audioCtx.sampleRate) * Math.pow(1 - i / bufferSize, 2);
        }

        const source = audioCtx.createBufferSource();
        const gain = audioCtx.createGain();
        source.buffer = buffer;
        gain.gain.value = volume;
        source.connect(gain).connect(audioCtx.destination);
        source.start();
    }


    function startMetronome() {
      const interval = (60 / bpm) * 1000;
      tick();
      intervalId = setInterval(tick, interval);
    }

    function stopMetronome() {
      clearInterval(intervalId);
    }

    bpmInput.addEventListener('change', (e) => {
      bpm = parseInt(e.target.value);
      localStorage.setItem('bpm', bpm);
      if (isRunning) {
        stopMetronome();
        startMetronome();
      }
    });

    bpmUp.addEventListener('click', () => {
      bpm = Math.min(300, bpm + 1);
      bpmInput.value = bpm;
      localStorage.setItem('bpm', bpm);
      if (isRunning) {
        stopMetronome();
        startMetronome();
      }
    });

    bpmDown.addEventListener('click', () => {
      bpm = Math.max(30, bpm - 1);
      bpmInput.value = bpm;
      localStorage.setItem('bpm', bpm);
      if (isRunning) {
        stopMetronome();
        startMetronome();
      }
    });

    volumeSlider.addEventListener('input', (e) => {
      volume = parseFloat(e.target.value);
      localStorage.setItem('volume', volume);
    });

    startStopBtn.addEventListener('click', () => {
      if (!isRunning) {
        audioCtx.resume();
        startMetronome();
        startStopBtn.textContent = 'Stop';
        isRunning = true;
      } else {
        stopMetronome();
        startStopBtn.textContent = 'Start';
        isRunning = false;
      }
    });
  </script>
</body>
</html>
